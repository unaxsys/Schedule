<!doctype html>
<html lang="bg">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Супер администраторски панел</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        background: linear-gradient(180deg, #edf2fb 0%, #dbe7fb 100%);
      }

      .sa-shell {
        max-width: 1280px;
        margin: 1.2rem auto;
        display: grid;
        gap: 1rem;
      }

      .sa-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .sa-header h1 {
        margin: 0;
      }

      .sa-live-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
        border-radius: 999px;
        padding: 0.2rem 0.55rem;
        font-size: 0.85rem;
      }

      .sa-dot {
        width: 0.55rem;
        height: 0.55rem;
        border-radius: 50%;
        background: #22c55e;
      }

      .sa-toolbar {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .sa-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        gap: 0.6rem;
      }

      .sa-stat {
        border: 1px solid #dbeafe;
        background: linear-gradient(180deg, #ffffff 0%, #f5f9ff 100%);
        border-radius: 12px;
        padding: 0.7rem;
      }

      .sa-stat strong {
        font-size: 1.2rem;
        display: block;
      }

      .sa-tenants {
        display: grid;
        gap: 0.75rem;
      }

      .sa-tenant {
        border: 1px solid #dbeafe;
        border-radius: 12px;
        padding: 0.8rem;
        background: #fff;
        display: grid;
        gap: 0.55rem;
      }

      .sa-tenant-head {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.8rem;
      }

      .sa-tenant-meta {
        color: #475569;
        font-size: 0.9rem;
        display: grid;
        gap: 0.12rem;
      }

      .sa-status-pill {
        border-radius: 999px;
        padding: 0.2rem 0.55rem;
        font-size: 0.8rem;
        text-transform: uppercase;
        font-weight: 700;
      }

      .sa-status-pill--pending {
        background: #fef9c3;
        color: #854d0e;
      }

      .sa-status-pill--approved {
        background: #dcfce7;
        color: #166534;
      }

      .sa-status-pill--disabled {
        background: #fee2e2;
        color: #991b1b;
      }

      .sa-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .sa-btn-warn {
        background: #d97706;
      }

      .sa-btn-danger {
        background: #dc2626;
      }

      .sa-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .sa-table-wrap {
        border: 1px solid #dbeafe;
        border-radius: 12px;
        background: #fff;
        overflow: auto;
        max-height: 420px;
      }

      .sa-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }

      .sa-table th,
      .sa-table td {
        border-bottom: 1px solid #e2e8f0;
        padding: 0.55rem 0.65rem;
        text-align: left;
        vertical-align: top;
      }

      .sa-table th {
        background: #eff6ff;
        font-weight: 700;
        color: #1e3a8a;
        position: sticky;
        top: 0;
      }

      .sa-table tr:hover td {
        background: #f8fafc;
      }

      .sa-empty {
        margin: 0;
        padding: 0.75rem;
        color: #64748b;
      }

      .sa-usage-stats {
        display: grid;
        grid-template-columns: repeat(2, minmax(110px, 1fr));
        gap: 0.45rem;
      }

      .sa-usage-pill {
        background: #f1f5f9;
        border-radius: 999px;
        padding: 0.25rem 0.55rem;
        font-size: 0.82rem;
        display: inline-flex;
        justify-content: space-between;
        gap: 0.4rem;
      }

      .sa-card-list {
        display: grid;
        gap: 0.65rem;
        max-height: 420px;
        overflow: auto;
      }

      .sa-row-card {
        border: 1px solid #dbeafe;
        border-radius: 12px;
        background: #fff;
        padding: 0.7rem;
        display: grid;
        gap: 0.45rem;
      }

      .sa-row-title {
        margin: 0;
        font-size: 0.92rem;
      }

      .sa-bubbles {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }

      .sa-bubble {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e3a8a;
        border-radius: 999px;
        padding: 0.2rem 0.55rem;
        font-size: 0.8rem;
        max-width: 100%;
      }

      #saStatus {
        font-weight: 600;
      }

      @media (max-width: 950px) {
        .sa-grid-2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="sa-shell">
      <section class="panel">
        <div class="sa-header">
          <div>
            <h1>Супер администраторски панел</h1>
            <p>Наблюдение и управление в реално време на регистрации и статуси на фирми.</p>
            <div class="sa-live-badge"><span class="sa-dot"></span> Live обновяване на всеки 5 секунди</div>
          </div>

          <div class="sa-toolbar">
            <label for="saApiUrl">API URL:</label>
            <input id="saApiUrl" type="text" placeholder="http://localhost:4000" />
            <button id="saConnectBtn" type="button">Свържи</button>
            <button id="saRefreshBtn" type="button">Обнови сега</button>
          </div>
        </div>

        <p id="saStatus"></p>
      </section>

      <section class="panel">
        <h3>Общо натоварване</h3>
        <div id="saUsageCards" class="sa-stats"></div>
      </section>

      <section class="panel">
        <h3>Регистрации на фирми</h3>
        <div id="saTenants" class="sa-tenants"></div>
      </section>

      <section class="panel sa-grid-2">
        <div>
          <h3>Таблици (read-only)</h3>
          <form id="saTableForm" class="employee-form">
            <select id="saTableName">
              <option value="tenants">tenants</option>
              <option value="users">users</option>
              <option value="tenant_users">tenant_users</option>
              <option value="audit_log">audit_log</option>
              <option value="request_log">request_log</option>
              <option value="employees">employees</option>
              <option value="departments">departments</option>
              <option value="schedules">schedules</option>
              <option value="schedule_entries">schedule_entries</option>
              <option value="shift_templates">shift_templates</option>
            </select>
            <button type="submit">Преглед</button>
          </form>
          <div id="saTableOutput" class="sa-card-list">
            <p class="sa-empty">Няма данни.</p>
          </div>
        </div>

        <div>
          <h3>Audit log (последни 200)</h3>
          <div id="saLogs" class="sa-card-list"><p class="sa-empty">Няма данни.</p></div>
        </div>
      </section>
    </main>

    <script>
      const apiUrlInput = document.getElementById('saApiUrl');
      const connectBtn = document.getElementById('saConnectBtn');
      const refreshBtn = document.getElementById('saRefreshBtn');
      const usageCards = document.getElementById('saUsageCards');
      const tenantsEl = document.getElementById('saTenants');
      const logsEl = document.getElementById('saLogs');
      const tableForm = document.getElementById('saTableForm');
      const tableNameInput = document.getElementById('saTableName');
      const tableOutput = document.getElementById('saTableOutput');
      const statusEl = document.getElementById('saStatus');

      const REFRESH_EVERY_MS = 5000;
      let refreshTimer = null;
      let apiBaseUrl = localStorage.getItem('apiBaseUrl') || `${window.location.protocol}//${window.location.hostname}:4000`;
      let previousTenantSnapshot = new Map();
      let tenantNameById = new Map();
      apiUrlInput.value = apiBaseUrl;

      function setStatus(text, ok = true) {
        statusEl.textContent = text;
        statusEl.style.color = ok ? '#166534' : '#b91c1c';
      }

      function fmtDate(value) {
        if (!value) {
          return '—';
        }
        try {
          return new Date(value).toLocaleString('bg-BG');
        } catch (_error) {
          return String(value);
        }
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      async function apiRequest(path, options = {}) {
        const headers = { ...(options.headers || {}), 'X-User-Role': 'super_admin' };
        const authToken = (localStorage.getItem('authToken') || '').trim();
        if (authToken && !headers.Authorization) {
          headers.Authorization = `Bearer ${authToken}`;
        }
        if (options.body && !headers['Content-Type']) {
          headers['Content-Type'] = 'application/json';
        }

        const response = await fetch(`${apiBaseUrl}${path}`, { ...options, headers });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.message || `HTTP ${response.status}`);
        }
        return payload;
      }

      async function updateTenantStatus(tenantId, status) {
        await apiRequest(`/api/platform/super-admin/registrations/${encodeURIComponent(tenantId)}/status`, {
          method: 'PATCH',
          body: JSON.stringify({ status }),
        });

        const labelByStatus = {
          approved: 'Фирмата е активирана/приета.',
          disabled: 'Фирмата е спряна (замразена/прекратена).',
          pending: 'Фирмата е върната в изчакване.',
        };
        setStatus(labelByStatus[status] || 'Статусът е обновен.');

        await refreshOverview(true);
      }

      function renderUsage(payload) {
        const usage = payload.usage || {};
        const usersByRole = payload.usersByRole || [];
        const roleSummary = usersByRole.map((item) => `${item.role}: ${item.count}`).join(' | ') || '—';

        const cards = [
          { label: 'Организации', value: usage.tenantsCount ?? 0 },
          { label: 'Потребители', value: usage.usersCount ?? 0 },
          { label: 'Служители', value: usage.employeesCount ?? 0 },
          { label: 'Графици', value: usage.schedulesCount ?? 0 },
          { label: 'Записи в графици', value: usage.scheduleEntriesCount ?? 0 },
          { label: 'Размер БД (bytes)', value: usage.databaseSizeBytes ?? 0 },
          { label: 'Потребители по роли', value: roleSummary },
        ];

        usageCards.innerHTML = cards
          .map((card) => `<div class="sa-stat"><span>${escapeHtml(card.label)}</span><strong>${escapeHtml(card.value)}</strong></div>`)
          .join('');
      }

      function getStatusBadge(status) {
        const normalized = String(status || '').toLowerCase();
        const labelByStatus = {
          pending: 'Изчаква',
          approved: 'Активна',
          disabled: 'Спряна',
        };
        const label = labelByStatus[normalized] || normalized;
        return `<span class="sa-status-pill sa-status-pill--${escapeHtml(normalized)}">${escapeHtml(label)}</span>`;
      }

      function actionsForTenant(tenant) {
        const id = JSON.stringify(tenant.id);
        if (tenant.status === 'pending') {
          return `
            <button type="button" onclick='window.__saUpdateStatus(${id}, "approved")'>Приеми</button>
            <button type="button" class="sa-btn-danger" onclick='window.__saUpdateStatus(${id}, "disabled")'>Отхвърли</button>
          `;
        }

        if (tenant.status === 'disabled') {
          return `<button type="button" class="btn-add" onclick='window.__saUpdateStatus(${id}, "approved")'>Активирай</button>`;
        }

        return `<button type="button" class="sa-btn-warn" onclick='window.__saUpdateStatus(${id}, "disabled")'>Замрази / Прекрати</button>`;
      }

      function renderTenants(payload) {
        const tenants = payload.tenants || [];
        const usageByTenantId = new Map((payload.tenantUsage || []).map((item) => [String(item.id), item]));
        tenantNameById = new Map(tenants.map((tenant) => [String(tenant.id), tenant.name || '—']));
        if (!tenants.length) {
          tenantsEl.innerHTML = '<div class="sa-tenant"><small>Няма регистрирани фирми.</small></div>';
          return;
        }

        const nextSnapshot = new Map();

        tenantsEl.innerHTML = tenants
          .map((tenant) => {
            const currentFingerprint = `${tenant.status}|${tenant.updatedAt || ''}|${tenant.approvedAt || ''}`;
            nextSnapshot.set(tenant.id, currentFingerprint);
            const changed = previousTenantSnapshot.get(tenant.id) && previousTenantSnapshot.get(tenant.id) !== currentFingerprint;

            const ownerName = tenant.ownerFullName || '—';
            const ownerEmail = tenant.ownerEmail || '—';
            const ownerPhone = tenant.ownerPhone || '—';
            const eik = tenant.eik || '—';
            const tenantUsage = usageByTenantId.get(String(tenant.id)) || {};

            return `
              <article class="sa-tenant" ${changed ? 'style="box-shadow:0 0 0 2px #bfdbfe inset;"' : ''}>
                <div class="sa-tenant-head">
                  <div>
                    <strong>${escapeHtml(tenant.name || 'Без име')}</strong>
                    <div class="sa-tenant-meta">
                      <span><strong>ЕИК:</strong> ${escapeHtml(eik)}</span>
                      <span><strong>Собственик:</strong> ${escapeHtml(ownerName)}</span>
                      <span><strong>Email:</strong> ${escapeHtml(ownerEmail)}</span>
                      <span><strong>Телефон:</strong> ${escapeHtml(ownerPhone)}</span>
                      <span><strong>Създадена:</strong> ${escapeHtml(fmtDate(tenant.createdAt))}</span>
                      <span><strong>Одобрена:</strong> ${escapeHtml(fmtDate(tenant.approvedAt))}</span>
                    </div>
                  </div>
                  <div>${getStatusBadge(tenant.status)}</div>
                </div>

                <div class="sa-usage-stats">
                  <span class="sa-usage-pill"><span>Потребители</span><strong>${escapeHtml(tenantUsage.usersCount ?? 0)}</strong></span>
                  <span class="sa-usage-pill"><span>Служители</span><strong>${escapeHtml(tenantUsage.employeesCount ?? 0)}</strong></span>
                  <span class="sa-usage-pill"><span>Отдели</span><strong>${escapeHtml(tenantUsage.departmentsCount ?? 0)}</strong></span>
                  <span class="sa-usage-pill"><span>Графици</span><strong>${escapeHtml(tenantUsage.schedulesCount ?? 0)}</strong></span>
                  <span class="sa-usage-pill"><span>Записи</span><strong>${escapeHtml(tenantUsage.scheduleEntriesCount ?? 0)}</strong></span>
                  <span class="sa-usage-pill"><span>Audit</span><strong>${escapeHtml(tenantUsage.auditEventsCount ?? 0)}</strong></span>
                  <span class="sa-usage-pill"><span>Заявки</span><strong>${escapeHtml(tenantUsage.requestsCount ?? 0)}</strong></span>
                </div>

                <div class="sa-actions">${actionsForTenant(tenant)}</div>
              </article>
            `;
          })
          .join('');

        previousTenantSnapshot = nextSnapshot;
      }

      function renderBubbles(row, hiddenKeys = new Set()) {
        const bubbles = Object.entries(row || {})
          .filter(([key]) => !hiddenKeys.has(key))
          .map(([key, value]) => `<span class="sa-bubble"><strong>${escapeHtml(prettifyColumnName(key))}:</strong> ${escapeHtml(formatTableValue(key, value))}</span>`)
          .join('');
        return bubbles || '<span class="sa-bubble">Няма детайли</span>';
      }

      function renderLogs(payload) {
        const logs = payload.logs || [];
        if (!logs.length) {
          logsEl.innerHTML = '<p class="sa-empty">Няма audit записи.</p>';
          return;
        }

        logsEl.innerHTML = logs
          .map(
            (log) => `
              <article class="sa-row-card">
                <p class="sa-row-title"><strong>${escapeHtml(log.action || 'audit')}</strong> · ${escapeHtml(log.entity || 'entity')} · ${escapeHtml(fmtDate(log.createdAt))}</p>
                <div class="sa-bubbles">${renderBubbles(log, new Set(['id', 'action', 'entity', 'createdAt']))}</div>
              </article>
            `,
          )
          .join('');
      }

      function prettifyColumnName(column) {
        const labels = {
          tenant_id: 'Фирма',
          tenantid: 'Фирма',
          company_id: 'Фирма',
          companyid: 'Фирма',
          created_at: 'Създадена',
          updated_at: 'Обновена',
          approved_at: 'Одобрена',
          deleted_at: 'Изтрита',
          full_name: 'Име',
          first_name: 'Име',
          last_name: 'Фамилия',
          phone_number: 'Телефон',
          email_address: 'Имейл',
          user_id: 'Потребител',
          role_id: 'Роля',
          schedule_id: 'График',
          department_id: 'Отдел',
          shift_template_id: 'Шаблон смяна',
        };

        const key = String(column || '')
          .replace(/([a-z])([A-Z])/g, '$1_$2')
          .toLowerCase();
        if (labels[key]) {
          return labels[key];
        }

        const normalized = key.replaceAll('_', ' ').trim();
        return normalized ? normalized[0].toUpperCase() + normalized.slice(1) : String(column || '');
      }

      function isTenantKey(key) {
        const normalized = String(key || '')
          .replace(/([a-z])([A-Z])/g, '$1_$2')
          .toLowerCase();
        return normalized === 'tenant_id' || normalized === 'tenantid' || normalized === 'company_id' || normalized === 'companyid';
      }

      function formatTableValue(key, value) {
        if (value === null || value === undefined || value === '') {
          return '—';
        }

        if (isTenantKey(key)) {
          return tenantNameById.get(String(value)) || `Непозната фирма (${value})`;
        }

        if (typeof value === 'boolean') {
          return value ? 'Да' : 'Не';
        }

        if (typeof value === 'object') {
          return JSON.stringify(value);
        }

        const keyName = String(key || '').toLowerCase();
        if (keyName.includes('date') || keyName.endsWith('at')) {
          return fmtDate(value);
        }

        return String(value);
      }

      function renderTableRows(tableName, rows) {
        if (!rows.length) {
          tableOutput.innerHTML = '<p class="sa-empty">Няма данни в избраната таблица.</p>';
          return;
        }

        const hiddenKeys = new Set();
        if (tableName === 'tenants') {
          hiddenKeys.add('id');
        }

        tableOutput.innerHTML = rows
          .map((row, index) => {
            const title = row.name || row.title || row.email || `Ред #${index + 1}`;
            return `
              <article class="sa-row-card">
                <p class="sa-row-title"><strong>${escapeHtml(title)}</strong></p>
                <div class="sa-bubbles">${renderBubbles(row, hiddenKeys)}</div>
              </article>
            `;
          })
          .join('');
      }

      async function refreshOverview(isAuto = false) {
        try {
          const payload = await apiRequest('/api/platform/super-admin/overview');
          renderUsage(payload);
          renderTenants(payload);
          renderLogs(payload);
          setStatus(`${isAuto ? 'Live' : 'Ръчно'} обновяване: ${new Date().toLocaleTimeString('bg-BG')}`);
        } catch (error) {
          setStatus(error.message, false);
        }
      }

      function startLiveRefresh() {
        if (refreshTimer) {
          clearInterval(refreshTimer);
        }
        refreshTimer = setInterval(() => {
          refreshOverview(true);
        }, REFRESH_EVERY_MS);
      }

      window.__saUpdateStatus = async (tenantId, status) => {
        try {
          await updateTenantStatus(tenantId, status);
        } catch (error) {
          setStatus(error.message, false);
        }
      };

      connectBtn.addEventListener('click', async () => {
        apiBaseUrl = apiUrlInput.value.trim().replace(/\/$/, '');
        localStorage.setItem('apiBaseUrl', apiBaseUrl);
        setStatus(`API URL е записан: ${apiBaseUrl}`);
        await refreshOverview();
      });

      refreshBtn.addEventListener('click', async () => {
        await refreshOverview();
      });

      tableForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        try {
          const tableName = tableNameInput.value;
          const payload = await apiRequest(`/api/platform/super-admin/tables/${encodeURIComponent(tableName)}`);
          renderTableRows(tableName, payload.rows || []);
          setStatus('Таблицата е заредена.');
        } catch (error) {
          setStatus(error.message, false);
        }
      });

      refreshOverview();
      startLiveRefresh();
    </script>
  </body>
</html>
